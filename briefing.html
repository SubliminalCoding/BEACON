<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>BEACON ‚Äî Daily Briefing</title>
  <style>
    * { margin: 0; padding: 0; box-sizing: border-box; }

    :root {
      --bg: #0d0a1e;
      --surface: #15103a;
      --border: #2e1f6e;
      --accent: #7050e0;
      --accent2: #42c8f5;
      --text: #e0d4ff;
      --muted: #8070b0;
      --success: #42f590;
      --warn: #f5a242;
      --danger: #f54242;
    }

    html, body {
      width: 520px;
      height: 620px;
      overflow: hidden;
      background: var(--bg);
      color: var(--text);
      font-family: 'Segoe UI', 'Consolas', sans-serif;
      font-size: 13px;
      -webkit-app-region: no-drag;
    }

    /* Titlebar */
    .titlebar {
      display: flex;
      align-items: center;
      justify-content: space-between;
      padding: 10px 16px;
      background: var(--surface);
      border-bottom: 1px solid var(--border);
      -webkit-app-region: drag;
    }
    .titlebar-left {
      display: flex;
      align-items: center;
      gap: 10px;
    }
    .beacon-dot {
      width: 10px; height: 10px;
      border-radius: 50%;
      background: var(--accent);
      box-shadow: 0 0 8px var(--accent);
      animation: pulse 2s infinite;
    }
    @keyframes pulse {
      0%, 100% { opacity: 1; }
      50% { opacity: 0.4; }
    }
    .titlebar h1 {
      font-size: 13px;
      font-weight: 600;
      letter-spacing: 2px;
      color: var(--accent2);
    }
    .titlebar .date {
      font-size: 11px;
      color: var(--muted);
    }
    .close-btn {
      -webkit-app-region: no-drag;
      background: none;
      border: none;
      color: var(--muted);
      cursor: pointer;
      font-size: 16px;
      padding: 2px 6px;
      border-radius: 4px;
      transition: all 0.2s;
    }
    .close-btn:hover { background: rgba(200,50,50,0.3); color: #ff6060; }

    /* Main content */
    .content {
      height: calc(100% - 48px);
      overflow-y: auto;
      padding: 16px;
      display: flex;
      flex-direction: column;
      gap: 14px;
    }
    .content::-webkit-scrollbar { width: 4px; }
    .content::-webkit-scrollbar-track { background: transparent; }
    .content::-webkit-scrollbar-thumb { background: var(--border); border-radius: 2px; }

    /* Coaching message banner */
    .coaching-banner {
      background: linear-gradient(135deg, rgba(112,80,224,0.2), rgba(66,200,245,0.1));
      border: 1px solid var(--border);
      border-radius: 8px;
      padding: 12px 14px;
      font-style: italic;
      color: var(--accent2);
      font-size: 12px;
      line-height: 1.5;
    }

    /* Section */
    .section {
      background: var(--surface);
      border: 1px solid var(--border);
      border-radius: 8px;
      overflow: hidden;
    }
    .section-header {
      display: flex;
      align-items: center;
      gap: 8px;
      padding: 8px 12px;
      border-bottom: 1px solid var(--border);
      font-size: 11px;
      font-weight: 600;
      letter-spacing: 1px;
      color: var(--muted);
      text-transform: uppercase;
    }
    .section-body { padding: 10px 12px; }

    /* Stats row */
    .stats-row {
      display: flex;
      gap: 12px;
    }
    .stat-box {
      flex: 1;
      background: rgba(112,80,224,0.1);
      border: 1px solid var(--border);
      border-radius: 6px;
      padding: 8px 10px;
      text-align: center;
    }
    .stat-val {
      font-size: 20px;
      font-weight: 700;
      color: var(--accent);
    }
    .stat-label {
      font-size: 10px;
      color: var(--muted);
      text-transform: uppercase;
      letter-spacing: 0.5px;
      margin-top: 2px;
    }

    /* Project row */
    .project-row {
      display: flex;
      align-items: center;
      gap: 10px;
      padding: 7px 0;
      border-bottom: 1px solid rgba(46,31,110,0.4);
      cursor: default;
    }
    .project-row:last-child { border-bottom: none; }
    .project-lang {
      font-size: 10px;
      background: rgba(112,80,224,0.2);
      color: var(--accent2);
      border-radius: 3px;
      padding: 1px 5px;
      min-width: 40px;
      text-align: center;
    }
    .project-name { flex: 1; font-weight: 600; }
    .project-meta { font-size: 11px; color: var(--muted); }
    .project-goals {
      font-size: 10px;
      background: rgba(66,245,144,0.1);
      color: var(--success);
      border-radius: 3px;
      padding: 1px 5px;
    }

    /* Goal row */
    .goal-row {
      display: flex;
      align-items: flex-start;
      gap: 8px;
      padding: 6px 0;
      border-bottom: 1px solid rgba(46,31,110,0.4);
    }
    .goal-row:last-child { border-bottom: none; }
    .goal-badge {
      font-size: 10px;
      border-radius: 3px;
      padding: 1px 5px;
      min-width: 50px;
      text-align: center;
    }
    .badge-overdue { background: rgba(245,66,66,0.15); color: var(--danger); }
    .badge-soon { background: rgba(245,162,66,0.15); color: var(--warn); }
    .goal-text { flex: 1; }
    .goal-project { font-size: 10px; color: var(--muted); }

    /* Suggestion box */
    .suggestion-box {
      background: rgba(66,200,245,0.08);
      border: 1px solid rgba(66,200,245,0.2);
      border-radius: 6px;
      padding: 10px 12px;
      font-size: 12px;
      color: var(--accent2);
      line-height: 1.5;
    }
    .suggestion-box strong { color: #fff; }

    /* Claude ask bar */
    .ask-bar {
      display: flex;
      gap: 8px;
      align-items: center;
    }
    .ask-bar input {
      flex: 1;
      background: var(--surface);
      border: 1px solid var(--border);
      border-radius: 6px;
      color: var(--text);
      font-family: inherit;
      font-size: 12px;
      padding: 7px 10px;
      outline: none;
      transition: border-color 0.2s;
    }
    .ask-bar input:focus { border-color: var(--accent); }
    .ask-bar input::placeholder { color: var(--muted); }
    .ask-btn {
      background: var(--accent);
      border: none;
      border-radius: 6px;
      color: #fff;
      font-size: 12px;
      padding: 7px 12px;
      cursor: pointer;
      transition: opacity 0.2s;
    }
    .ask-btn:hover { opacity: 0.85; }
    .ask-btn:disabled { opacity: 0.4; cursor: default; }
    .ask-response {
      font-size: 12px;
      color: var(--accent2);
      font-style: italic;
      line-height: 1.5;
      margin-top: 6px;
      display: none;
    }

    /* Empty state */
    .empty { color: var(--muted); font-size: 12px; padding: 4px 0; }

    /* Neglected warning */
    .neglected-row {
      display: flex;
      align-items: center;
      gap: 8px;
      padding: 5px 0;
      border-bottom: 1px solid rgba(46,31,110,0.4);
    }
    .neglected-row:last-child { border-bottom: none; }
    .neglect-days {
      font-size: 10px;
      background: rgba(245,162,66,0.15);
      color: var(--warn);
      border-radius: 3px;
      padding: 1px 5px;
    }
  </style>
</head>
<body>
  <div class="titlebar">
    <div class="titlebar-left">
      <div class="beacon-dot"></div>
      <h1>BEACON</h1>
      <span class="date" id="date-display"></span>
    </div>
    <button class="close-btn" id="close-btn">‚úï</button>
  </div>

  <div class="content" id="content">
    <div style="text-align:center;padding:40px;color:#6050a0">Loading briefing...</div>
  </div>

  <script>
    document.getElementById('close-btn').addEventListener('click', () => window.beacon.closeWindow());
    document.getElementById('date-display').textContent = new Date().toLocaleDateString('en-US', { weekday:'long', month:'long', day:'numeric' });

    function formatMs(ms) {
      if (!ms || ms < 60000) return '< 1m';
      const h = Math.floor(ms / 3600000);
      const m = Math.floor((ms % 3600000) / 60000);
      return h > 0 ? `${h}h ${m}m` : `${m}m`;
    }

    function timeAgo(ts) {
      if (!ts) return 'never';
      const diff = Date.now() - ts;
      const d = Math.floor(diff / 86400000);
      const h = Math.floor(diff / 3600000);
      const m = Math.floor(diff / 60000);
      if (d >= 1) return `${d}d ago`;
      if (h >= 1) return `${h}h ago`;
      return `${m}m ago`;
    }

    function renderBriefing(data) {
      if (!data) return;

      const streak = data.streak || {};
      const lastSession = data.lastSession;
      const recentProjects = data.recentProjects || [];
      const neglectedProjects = data.neglectedProjects || [];
      const overdueGoals = data.overdueGoals || [];
      const upcomingGoals = data.upcomingGoals || [];

      let html = '';

      // Coaching banner
      html += `<div class="coaching-banner">"${data.coachingMessage || 'Good morning. Let\'s get to work.'}"</div>`;

      // Stats row
      html += `<div class="stats-row">
        <div class="stat-box">
          <div class="stat-val">${streak.current || 0}</div>
          <div class="stat-label">Day Streak</div>
        </div>
        <div class="stat-box">
          <div class="stat-val">${recentProjects.length}</div>
          <div class="stat-label">Projects</div>
        </div>
        <div class="stat-box">
          <div class="stat-val">${overdueGoals.length}</div>
          <div class="stat-label">Overdue</div>
        </div>
      </div>`;

      // Last session
      if (lastSession) {
        html += `<div class="section">
          <div class="section-header">‚è± Last Session</div>
          <div class="section-body">
            <div class="project-row">
              <span class="project-name">${lastSession.projectName || 'Unknown Project'}</span>
              <span class="project-meta">${formatMs(lastSession.durationMs)} ¬∑ ${timeAgo(lastSession.endedAt)}</span>
            </div>
            ${lastSession.summary ? `<div style="font-size:11px;color:#8070b0;margin-top:6px;font-style:italic">${lastSession.summary}</div>` : ''}
          </div>
        </div>`;
      }

      // Suggestion
      html += `<div class="suggestion-box">
        <strong>BEACON suggests:</strong> ${data.suggestion || 'Start a new session and make progress today.'}
      </div>`;

      // Recent projects
      if (recentProjects.length > 0) {
        const rows = recentProjects.map(p => `
          <div class="project-row">
            <span class="project-lang">${(p.language || '?').slice(0,6)}</span>
            <span class="project-name">${p.name}</span>
            ${p.goalsCount > 0 ? `<span class="project-goals">${p.goalsCount} goals</span>` : ''}
            <span class="project-meta">${p.daysSinceActive != null ? p.daysSinceActive === 0 ? 'today' : `${p.daysSinceActive}d ago` : 'new'}</span>
          </div>`).join('');
        html += `<div class="section">
          <div class="section-header">üìÅ Active Projects</div>
          <div class="section-body">${rows}</div>
        </div>`;
      }

      // Overdue goals
      if (overdueGoals.length > 0) {
        const rows = overdueGoals.map(g => `
          <div class="goal-row">
            <span class="goal-badge badge-overdue">${g.daysOverdue}d late</span>
            <div class="goal-text">
              <div>${g.title}</div>
              <div class="goal-project">${g.projectName}</div>
            </div>
          </div>`).join('');
        html += `<div class="section">
          <div class="section-header">‚ö†Ô∏è Overdue Goals</div>
          <div class="section-body">${rows}</div>
        </div>`;
      }

      // Upcoming goals
      if (upcomingGoals.length > 0) {
        const rows = upcomingGoals.map(g => {
          const daysLeft = Math.ceil((g.dueDate - Date.now()) / 86400000);
          return `<div class="goal-row">
            <span class="goal-badge badge-soon">${daysLeft}d left</span>
            <div class="goal-text">
              <div>${g.title}</div>
              <div class="goal-project">${g.projectName}</div>
            </div>
          </div>`;
        }).join('');
        html += `<div class="section">
          <div class="section-header">üìÖ Due Soon</div>
          <div class="section-body">${rows}</div>
        </div>`;
      }

      // Active Reminders
      const pendingReminders = data.pendingReminders || [];
      if (pendingReminders.length > 0) {
        const badgeMap = { 'one-shot': 'badge-soon', 'recurring': 'badge-overdue', 'project-context': 'badge-soon' };
        const labelMap = { 'one-shot': 'once', 'recurring': 'repeat', 'project-context': 'project' };
        const rows = pendingReminders.map(r => `
          <div class="project-row">
            <span class="goal-badge ${badgeMap[r.type] || 'badge-soon'}">${labelMap[r.type] || r.type}</span>
            <span class="project-name" style="font-size:12px">${r.text}</span>
            <span class="project-meta">${r.schedule}</span>
          </div>`).join('');
        html += `<div class="section">
          <div class="section-header">&#x23F0; Active Reminders</div>
          <div class="section-body">${rows}</div>
        </div>`;
      }

      // Neglected
      if (neglectedProjects.length > 0) {
        const rows = neglectedProjects.map(p => `
          <div class="neglected-row">
            <span class="neglect-days">${p.daysSinceActive}d idle</span>
            <span>${p.name}</span>
          </div>`).join('');
        html += `<div class="section">
          <div class="section-header">üí§ Neglected</div>
          <div class="section-body">${rows}</div>
        </div>`;
      }

      // Ask BEACON
      html += `<div class="section">
        <div class="section-header">üí¨ Ask BEACON</div>
        <div class="section-body">
          <div class="ask-bar">
            <input type="text" id="ask-input" placeholder="What should I work on today?">
            <button class="ask-btn" id="ask-btn">Ask</button>
          </div>
          <div class="ask-response" id="ask-response"></div>
        </div>
      </div>`;

      document.getElementById('content').innerHTML = html;

      // Wire up ask
      const askBtn = document.getElementById('ask-btn');
      const askInput = document.getElementById('ask-input');
      const askResponse = document.getElementById('ask-response');

      askBtn.addEventListener('click', async () => {
        const q = askInput.value.trim();
        if (!q) return;
        askBtn.disabled = true;
        askBtn.textContent = '...';
        askResponse.style.display = 'none';
        const answer = await window.beacon.claudeAsk(q);
        askResponse.textContent = answer || 'Claude coaching not enabled ‚Äî add your API key in Settings.';
        askResponse.style.display = 'block';
        askBtn.disabled = false;
        askBtn.textContent = 'Ask';
      });

      askInput.addEventListener('keydown', e => {
        if (e.key === 'Enter') askBtn.click();
      });
    }

    // Receive briefing data from main process
    window.beacon.on('briefing-data', renderBriefing);

    // Also try to fetch it directly
    window.beacon.getBriefing().then(data => {
      if (data) renderBriefing(data);
    }).catch(() => {});
  </script>
</body>
</html>
