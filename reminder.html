<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>BEACON — Reminders</title>
  <style>
    * { margin:0; padding:0; box-sizing:border-box; }
    :root {
      --bg:#0d0a1e; --surface:#15103a; --border:#2e1f6e;
      --accent:#7050e0; --accent2:#42c8f5;
      --text:#e0d4ff; --muted:#8070b0;
      --success:#42f590; --warn:#f5a242; --danger:#f54242;
    }
    html,body { width:420px; height:520px; overflow:hidden; background:var(--bg); color:var(--text); font-family:'Segoe UI',sans-serif; font-size:13px; }

    .titlebar { display:flex; align-items:center; justify-content:space-between; padding:10px 16px; background:var(--surface); border-bottom:1px solid var(--border); -webkit-app-region:drag; }
    .titlebar-left { display:flex; align-items:center; gap:10px; }
    .beacon-dot { width:10px; height:10px; border-radius:50%; background:var(--accent); box-shadow:0 0 8px var(--accent); animation:pulse 2s infinite; }
    @keyframes pulse { 0%,100%{opacity:1} 50%{opacity:0.4} }
    .titlebar h1 { font-size:13px; font-weight:600; letter-spacing:2px; color:var(--accent2); }
    .close-btn { -webkit-app-region:no-drag; background:none; border:none; color:var(--muted); cursor:pointer; font-size:16px; padding:2px 6px; border-radius:4px; }
    .close-btn:hover { background:rgba(200,50,50,0.3); color:#ff6060; }

    .content { height:calc(100% - 44px); overflow-y:auto; padding:16px; display:flex; flex-direction:column; gap:14px; }
    .content::-webkit-scrollbar { width:4px; }
    .content::-webkit-scrollbar-thumb { background:var(--border); border-radius:2px; }

    .section { background:var(--surface); border:1px solid var(--border); border-radius:8px; overflow:hidden; }
    .section-header { padding:8px 12px; border-bottom:1px solid var(--border); font-size:11px; font-weight:600; letter-spacing:1px; color:var(--muted); text-transform:uppercase; }
    .section-body { padding:12px; display:flex; flex-direction:column; gap:10px; }

    .form-row { display:flex; align-items:center; gap:8px; }
    .form-label { font-size:11px; color:var(--muted); min-width:50px; }

    select, .text-input, .num-input {
      background:rgba(0,0,0,0.2); border:1px solid var(--border); border-radius:4px;
      color:var(--text); font-family:inherit; font-size:12px; padding:5px 8px; outline:none;
    }
    select { cursor:pointer; }
    select:focus, .text-input:focus, .num-input:focus { border-color:var(--accent); }
    .text-input { flex:1; }
    .text-input::placeholder { color:var(--muted); }
    .num-input { width:70px; text-align:center; }

    .add-btn { background:var(--accent); border:none; border-radius:6px; color:#fff; font-size:12px; padding:7px 16px; cursor:pointer; transition:opacity 0.2s; align-self:flex-end; }
    .add-btn:hover { opacity:0.85; }
    .add-btn:disabled { opacity:0.4; cursor:default; }

    .reminder-row {
      display:flex; align-items:center; gap:8px;
      padding:7px 0; border-bottom:1px solid rgba(46,31,110,0.4);
    }
    .reminder-row:last-child { border-bottom:none; }

    .type-badge {
      font-size:9px; border-radius:3px; padding:2px 5px;
      text-transform:uppercase; letter-spacing:0.5px; min-width:55px; text-align:center;
    }
    .badge-oneshot { background:rgba(66,200,245,0.15); color:var(--accent2); }
    .badge-recurring { background:rgba(66,245,144,0.15); color:var(--success); }
    .badge-context { background:rgba(245,162,66,0.15); color:var(--warn); }

    .reminder-text { flex:1; font-size:12px; }
    .reminder-schedule { font-size:10px; color:var(--muted); }

    .del-btn { background:none; border:1px solid rgba(245,66,66,0.3); border-radius:4px; color:var(--danger); font-size:11px; padding:2px 8px; cursor:pointer; opacity:0.7; transition:opacity 0.2s; }
    .del-btn:hover { opacity:1; background:rgba(245,66,66,0.1); }

    .empty { color:var(--muted); font-size:12px; padding:4px 0; }

    #dynamic-fields { min-height:34px; }
  </style>
</head>
<body>
  <div class="titlebar">
    <div class="titlebar-left">
      <div class="beacon-dot"></div>
      <h1>REMINDERS</h1>
    </div>
    <button class="close-btn" id="close-btn">&#x2715;</button>
  </div>

  <div class="content">
    <!-- Create reminder -->
    <div class="section">
      <div class="section-header">New Reminder</div>
      <div class="section-body">
        <div class="form-row">
          <span class="form-label">Type</span>
          <select id="type-select" style="flex:1">
            <option value="at-time">At a specific time</option>
            <option value="in-minutes">In X minutes</option>
            <option value="every-hours">Every X hours</option>
            <option value="daily-at">Daily at HH:MM</option>
            <option value="project-context">When I open a project</option>
          </select>
        </div>

        <div id="dynamic-fields"></div>

        <div class="form-row">
          <span class="form-label">Text</span>
          <input type="text" class="text-input" id="reminder-text" placeholder="What should BEACON remind you?">
        </div>

        <button class="add-btn" id="add-btn">Add Reminder</button>
      </div>
    </div>

    <!-- Active reminders -->
    <div class="section">
      <div class="section-header">Active Reminders</div>
      <div class="section-body" id="reminders-list">
        <div class="empty">No reminders set.</div>
      </div>
    </div>
  </div>

  <script>
    const closeBtn = document.getElementById('close-btn');
    const typeSelect = document.getElementById('type-select');
    const dynamicFields = document.getElementById('dynamic-fields');
    const textInput = document.getElementById('reminder-text');
    const addBtn = document.getElementById('add-btn');
    const remindersList = document.getElementById('reminders-list');

    closeBtn.addEventListener('click', () => window.beacon.closeWindow());

    // ─── Dynamic fields based on type ───────────────────────────────────────
    let projectsCache = [];

    function renderDynamicFields() {
      const type = typeSelect.value;
      let html = '';

      if (type === 'at-time') {
        const now = new Date();
        const local = new Date(now.getTime() - now.getTimezoneOffset() * 60000).toISOString().slice(0, 16);
        html = `<div class="form-row">
          <span class="form-label">When</span>
          <input type="datetime-local" class="text-input" id="field-datetime" value="${local}">
        </div>`;
      } else if (type === 'in-minutes') {
        html = `<div class="form-row">
          <span class="form-label">Minutes</span>
          <input type="number" class="num-input" id="field-minutes" value="30" min="1" max="1440">
        </div>`;
      } else if (type === 'every-hours') {
        html = `<div class="form-row">
          <span class="form-label">Hours</span>
          <input type="number" class="num-input" id="field-hours" value="2" min="1" max="24" step="0.5">
        </div>`;
      } else if (type === 'daily-at') {
        html = `<div class="form-row">
          <span class="form-label">Time</span>
          <input type="time" class="text-input" id="field-time" value="09:00" style="width:120px;flex:none">
        </div>`;
      } else if (type === 'project-context') {
        const opts = projectsCache.map(p =>
          `<option value="${p.id}">${p.name}</option>`
        ).join('');
        html = `<div class="form-row">
          <span class="form-label">Project</span>
          <select id="field-project" style="flex:1">${opts || '<option value="">No projects</option>'}</select>
        </div>`;
      }

      dynamicFields.innerHTML = html;
    }

    typeSelect.addEventListener('change', renderDynamicFields);

    // ─── Add reminder ───────────────────────────────────────────────────────

    addBtn.addEventListener('click', async () => {
      const text = textInput.value.trim();
      if (!text) { textInput.focus(); return; }

      const type = typeSelect.value;
      const data = { text };

      if (type === 'at-time') {
        const dt = document.getElementById('field-datetime');
        if (!dt || !dt.value) return;
        data.type = 'one-shot';
        data.fireAt = new Date(dt.value).getTime();
      } else if (type === 'in-minutes') {
        const mins = parseInt(document.getElementById('field-minutes')?.value);
        if (!mins || mins < 1) return;
        data.type = 'one-shot';
        data.fireAt = Date.now() + mins * 60000;
      } else if (type === 'every-hours') {
        const hrs = parseFloat(document.getElementById('field-hours')?.value);
        if (!hrs || hrs < 0.5) return;
        data.type = 'recurring';
        data.intervalMs = hrs * 3600000;
      } else if (type === 'daily-at') {
        const time = document.getElementById('field-time')?.value;
        if (!time) return;
        data.type = 'recurring';
        data.recurringTime = time;
      } else if (type === 'project-context') {
        const sel = document.getElementById('field-project');
        if (!sel || !sel.value) return;
        data.type = 'project-context';
        data.projectId = sel.value;
        data.projectName = sel.options[sel.selectedIndex]?.textContent || sel.value;
      }

      addBtn.disabled = true;
      await window.beacon.addReminder(data);
      textInput.value = '';
      addBtn.disabled = false;
      loadReminders();
    });

    // ─── Render list ────────────────────────────────────────────────────────

    function formatSchedule(r) {
      if (r.type === 'one-shot' && r.fireAt) {
        return `At ${new Date(r.fireAt).toLocaleString()}`;
      }
      if (r.type === 'recurring' && r.intervalMs) {
        const hrs = r.intervalMs / 3600000;
        return hrs >= 1 ? `Every ${hrs}h` : `Every ${Math.round(r.intervalMs / 60000)}m`;
      }
      if (r.type === 'recurring' && r.recurringTime) {
        return `Daily at ${r.recurringTime}`;
      }
      if (r.type === 'project-context') {
        return `When "${r.projectName || 'project'}" opens`;
      }
      return '';
    }

    function badgeClass(type) {
      if (type === 'one-shot') return 'badge-oneshot';
      if (type === 'recurring') return 'badge-recurring';
      return 'badge-context';
    }

    function badgeLabel(type) {
      if (type === 'one-shot') return 'once';
      if (type === 'recurring') return 'repeat';
      return 'project';
    }

    async function loadReminders() {
      const reminders = await window.beacon.getReminders();
      const active = reminders.filter(r => r.status === 'active');

      if (active.length === 0) {
        remindersList.innerHTML = '<div class="empty">No reminders set.</div>';
        return;
      }

      remindersList.innerHTML = active.map(r => `
        <div class="reminder-row">
          <span class="type-badge ${badgeClass(r.type)}">${badgeLabel(r.type)}</span>
          <div style="flex:1;min-width:0">
            <div class="reminder-text">${escHtml(r.text)}</div>
            <div class="reminder-schedule">${formatSchedule(r)}</div>
          </div>
          <button class="del-btn" data-id="${r.id}">Delete</button>
        </div>
      `).join('');

      remindersList.querySelectorAll('.del-btn').forEach(btn => {
        btn.addEventListener('click', async () => {
          await window.beacon.deleteReminder(btn.dataset.id);
          loadReminders();
        });
      });
    }

    function escHtml(str) {
      const d = document.createElement('div');
      d.textContent = str;
      return d.innerHTML;
    }

    // ─── Init ───────────────────────────────────────────────────────────────

    async function init() {
      projectsCache = await window.beacon.getProjectsForReminder();
      renderDynamicFields();
      loadReminders();
    }

    init();
  </script>
</body>
</html>
